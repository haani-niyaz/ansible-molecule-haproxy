# Generated by 'docker-haproxy' ansible role
global
    log 127.0.0.1 local2
    pidfile {{ haproxy_pidfile }}
    user {{ haproxy_user }}
    group {{ haproxy_group }}
    maxconn 1000

defaults
    log global
    mode http
    option httplog
    option dontlognull
    timeout connect 50000ms
    timeout client  50000ms
    timeout server  50000ms
 

{% for svc in haproxy_frontend_services %}
frontend {{svc.name}}
{% if svc.bind is defined %}
{% for bind in svc.bind %}
    bind *:{{ bind }}
{% endfor %}
{% else %}
    bind *:{{ svc.port }}
{% endif %}
    mode {{ svc.mode }}

{% if svc.redirect is defined %}
    {{ svc.redirect }}
{% endif %}
{% if svc.options is defined %}
{% for option in svc.options %}
    option {{ option }}
{% endfor %}
{% endif %}
{% if svc.misc is defined %}
{% for key, value in svc.misc.iteritems() %}
    {{ key }} {{ value }}
{% endfor %}
{% endif %}
{% if svc.acls is defined %}
{% for item in svc.acls %}
{% for acl in item.entries %}
    acl {{ item.name }} {{ acl.criteria }} {{ acl.pattern }}
{% endfor %}
{% if item.backend is defined %}
    use_backend {{ item.backend }}_backend {{ item.name }}
{% endif %}
{% endfor %}
{% endif %}
{% if svc.default_backend is defined %}
    default_backend {{ svc.default_backend }}_backend
{% endif %}
{% endfor %}


{% for backend in haproxy_backend_services %}
backend {{backend.name}}_backend
    mode {{backend.mode}}
{% if backend.options is defined %}
{% for option in backend.options %}
    option {{ option }}
{% endfor %}
{% endif %}
{% if backend.misc is defined %}
{% for key, value in backend.misc.iteritems() %}
    {{ key }} {{ value }}
{% endfor %}
{% endif %}
{% for backend in backend.hosts %}
    server {{backend.name}} {{backend.host}}:{{backend.port}} {% if backend.params is defined %} {{backend.params}} {% endif %} check
{% endfor %}
{% endfor %}
